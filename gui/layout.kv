#:import Graph kivy.garden.graph.Graph
#:import MeshLinePlot kivy.garden.graph.MeshLinePlot
#:import dp kivy.metrics.dp
#:import Image kivy.uix.image.Image
#:import RoundedRectangle kivy.graphics.RoundedRectangle
#:import Line kivy.graphics.Line

#:set COLOR_PRIMARY (0/255, 105/255, 170/255, 1)
#:set COLOR_DARK (0/255, 85/255, 142/255, 1)
#:set COLOR_WHITE (1, 1, 1, 1)
#:set COLOR_BG_LIGHT (245/255, 248/255, 252/255, 1)
#:set COLOR_TEXT_DARK (0.1, 0.1, 0.1, 1)
#:set COLOR_TEXT_LIGHT (1, 1, 1, 1)
#:set COLOR_GREY (0.8, 0.8, 0.8, 1)

<DashboardScreen>:
    canvas.before:
        Color:
            rgba: COLOR_BG_LIGHT
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: 'vertical'
        spacing: 0

        # 1. Barra de Herramientas Superior
        BoxLayout:
            size_hint_y: None
            height: dp(65)
            padding: [dp(15), dp(5)]
            spacing: dp(15)
            canvas.before:
                Color:
                    rgba: COLOR_PRIMARY
                Rectangle:
                    pos: self.pos
                    size: self.size
            Label:
                text: 'ScanIA'
                font_size: '30sp'
                bold: True
                color: COLOR_TEXT_LIGHT
                size_hint_x: 0.7
                halign: 'left'
                valign: 'middle'
                text_size: self.size
            
            BoxLayout:
                size_hint_x: 0.3
                spacing: dp(8)
                padding: [0, dp(10)]
                Button:
                    text: 'Exportar'
                    on_press: root.export_results_to_pdf()
                    background_normal: ''
                    background_color: COLOR_DARK
                    color: COLOR_TEXT_LIGHT
                    font_size: '13sp'
                    bold: True
                Button:
                    text: 'Ayuda'
                    background_normal: ''
                    background_color: COLOR_DARK
                    color: COLOR_TEXT_LIGHT
                    font_size: '13sp'
                    bold: True

        # 2. Área Principal de Contenido
        BoxLayout:
            orientation: 'horizontal'
            spacing: dp(8)
            padding: dp(8)

            # Panel Izquierdo (Configuración)
            ScrollView:
                size_hint_x: 0.4
                bar_width: dp(8)
                do_scroll_x: False
                GridLayout:
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)
                    padding: dp(12)
                    
                    Label:
                        text: 'CONFIGURACIÓN DE ESCANEO'
                        font_size: '18sp'
                        bold: True
                        size_hint_y: None
                        height: dp(35)
                        color: COLOR_TEXT_DARK
                        halign: 'left'
                        text_size: self.width, None

                    # Rango de IP
                    Label:
                        text: 'Rango de IP:'
                        size_hint_y: None
                        height: dp(20)
                        color: COLOR_TEXT_DARK
                        halign: 'left'
                        text_size: self.width, None
                    BoxLayout:
                        size_hint_y: None
                        height: dp(35)
                        spacing: dp(3)
                        TextInput:
                            id: ip_inicial_octet1
                            on_text: root._validate_octet_input("ip_inicial_octet1", self); root._handle_octet_input("ip_inicial_octet1", self, self.text)
                            input_filter: 'int'
                            multiline: False
                            halign: 'center'
                            max_length: 3
                        Label:
                            text: '.'
                            size_hint_x: None
                            width: dp(10)
                            color: COLOR_TEXT_DARK
                        TextInput:
                            id: ip_inicial_octet2
                            on_text: root._validate_octet_input("ip_inicial_octet2", self); root._handle_octet_input("ip_inicial_octet2", self, self.text)
                            input_filter: 'int'
                            multiline: False
                            halign: 'center'
                            max_length: 3
                        Label:
                            text: '.'
                            size_hint_x: None
                            width: dp(10)
                            color: COLOR_TEXT_DARK
                        TextInput:
                            id: ip_inicial_octet3
                            on_text: root._validate_octet_input("ip_inicial_octet3", self); root._handle_octet_input("ip_inicial_octet3", self, self.text)
                            input_filter: 'int'
                            multiline: False
                            halign: 'center'
                            max_length: 3
                        Label:
                            text: '.'
                            size_hint_x: None
                            width: dp(10)
                            color: COLOR_TEXT_DARK
                        TextInput:
                            id: ip_inicial_octet4
                            on_text: root._validate_octet_input("ip_inicial_octet4", self); root._handle_octet_input("ip_inicial_octet4", self, self.text)
                            input_filter: 'int'
                            multiline: False
                            halign: 'center'
                            max_length: 3
                    Label:
                        text: 'hasta'
                        size_hint_y: None
                        height: dp(20)
                        color: COLOR_TEXT_DARK
                        halign: 'left'
                        text_size: self.width, None
                    BoxLayout:
                        size_hint_y: None
                        height: dp(35)
                        spacing: dp(3)
                        TextInput:
                            id: ip_final_octet1
                            on_text: root._validate_octet_input("ip_final_octet1", self); root._handle_octet_input("ip_final_octet1", self, self.text)
                            input_filter: 'int'
                            multiline: False
                            halign: 'center'
                            max_length: 3
                        Label:
                            text: '.'
                            size_hint_x: None
                            width: dp(10)
                            color: COLOR_TEXT_DARK
                        TextInput:
                            id: ip_final_octet2
                            on_text: root._validate_octet_input("ip_final_octet2", self); root._handle_octet_input("ip_final_octet2", self, self.text)
                            input_filter: 'int'
                            multiline: False
                            halign: 'center'
                            max_length: 3
                        Label:
                            text: '.'
                            size_hint_x: None
                            width: dp(10)
                            color: COLOR_TEXT_DARK
                        TextInput:
                            id: ip_final_octet3
                            on_text: root._validate_octet_input("ip_final_octet3", self); root._handle_octet_input("ip_final_octet3", self, self.text)
                            input_filter: 'int'
                            multiline: False
                            halign: 'center'
                            max_length: 3
                        Label:
                            text: '.'
                            size_hint_x: None
                            width: dp(10)
                            color: COLOR_TEXT_DARK
                        TextInput:
                            id: ip_final_octet4
                            on_text: root._validate_octet_input("ip_final_octet4", self); root._handle_octet_input("ip_final_octet4", self, self.text)
                            on_text_validate: root.validar_y_analizar()
                            input_filter: 'int'
                            multiline: False
                            halign: 'center'
                            max_length: 3

                    # Opciones de Escaneo
                    Label:
                        text: 'Opciones de Escaneo:'
                        size_hint_y: None
                        height: dp(25)
                        color: COLOR_TEXT_DARK
                        bold: True
                        halign: 'left'
                        text_size: self.width, None
                    
                    GridLayout:
                        cols: 1
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(10)
                        
                        BoxLayout:
                            size_hint_y: None
                            height: dp(24)
                            CheckBox:
                                id: nmap_opt_sS
                                active: False
                                size_hint_x: None
                                width: dp(40)
                            Label:
                                text: 'Escaneo SYN (-sS)'
                                color: COLOR_TEXT_DARK
                                halign: 'left'
                                valign: 'middle'
                                text_size: self.width, None
                        
                        BoxLayout:
                            size_hint_y: None
                            height: dp(24)
                            CheckBox:
                                id: nmap_opt_sT
                                active: False
                                size_hint_x: None
                                width: dp(40)
                            Label:
                                text: 'Escaneo TCP Connect (-sT)'
                                color: COLOR_TEXT_DARK
                                halign: 'left'
                                valign: 'middle'
                                text_size: self.width, None
                        
                        BoxLayout:
                            size_hint_y: None
                            height: dp(24)
                            CheckBox:
                                id: nmap_opt_sU
                                active: False
                                size_hint_x: None
                                width: dp(40)
                            Label:
                                text: 'Escaneo UDP (-sU)'
                                color: COLOR_TEXT_DARK
                                halign: 'left'
                                valign: 'middle'
                                text_size: self.width, None
                        
                        BoxLayout:
                            size_hint_y: None
                            height: dp(24)
                            CheckBox:
                                id: nmap_opt_O
                                active: False
                                size_hint_x: None
                                width: dp(40)
                            Label:
                                text: 'Detección de S.O. (-O)'
                                color: COLOR_TEXT_DARK
                                halign: 'left'
                                valign: 'middle'
                                text_size: self.width, None
                        
                        BoxLayout:
                            size_hint_y: None
                            height: dp(24)
                            CheckBox:
                                id: nmap_opt_sV
                                active: True
                                size_hint_x: None
                                width: dp(40)
                            Label:
                                text: 'Detección de Versión (-sV)'
                                color: COLOR_TEXT_DARK
                                halign: 'left'
                                valign: 'middle'
                                text_size: self.width, None
                        
                        BoxLayout:
                            size_hint_y: None
                            height: dp(24)
                            CheckBox:
                                id: nmap_opt_Pn
                                active: True
                                size_hint_x: None
                                width: dp(40)
                            Label:
                                text: 'No hacer Ping (-Pn)'
                                color: COLOR_TEXT_DARK
                                halign: 'left'
                                valign: 'middle'
                                text_size: self.width, None
                        
                        BoxLayout:
                            size_hint_y: None
                            height: dp(24)
                            CheckBox:
                                id: nmap_opt_vulners
                                active: True
                                size_hint_x: None
                                width: dp(40)
                            Label:
                                text: 'Análisis Vulners (--script vulners)'
                                color: COLOR_TEXT_DARK
                                halign: 'left'
                                valign: 'middle'
                                text_size: self.width, None

                    # Argumentos Adicionales
                    Label:
                        text: 'Argumentos Adicionales:'
                        size_hint_y: None
                        height: dp(20)
                        color: COLOR_TEXT_DARK
                        halign: 'left'
                        text_size: self.width, None
                    TextInput:
                        id: custom_nmap_args_input
                        hint_text: 'Ej: -T4 --top-ports 20'
                        size_hint_y: None
                        height: dp(35)

                    Widget:
                        size_hint_y: None
                        height: dp(15)

                    # Botón de Escaneo
                    Button:
                        id: scan_button
                        text: "DETENER ESCANEO" if root.scan_active else "INICIAR ESCANEO"
                        size_hint_y: None
                        height: dp(50)
                        font_size: '16sp'
                        bold: True
                        background_normal: ''
                        background_color: (0.9, 0.2, 0.2, 1) if root.scan_active else COLOR_PRIMARY
                        color: COLOR_TEXT_LIGHT
                        on_press: root.validar_y_analizar()

                    # Etiqueta de Estado
                    Label:
                        id: status_label
                        markup: True
                        text: 'Listo para escanear.'
                        font_size: '14sp'
                        size_hint_y: None
                        height: dp(80)
                        text_size: self.width, None
                        halign: 'center'
                        valign: 'middle'
                        color: COLOR_TEXT_DARK

            # Panel Derecho (Resultados)
            RelativeLayout:
                id: results_panel
                size_hint_x: 0.6
                canvas.before:
                    Color:
                        id: results_panel_bg_color
                        rgba: (0, 0, 0, 0) # Empezamos con fondo transparente
                    Rectangle:
                        pos: self.pos
                        size: self.size
                
                Image:
                    id: results_background
                    source: 'gui/assets/Fondo.jpg'
                    size_hint: 0.7, 0.7
                    pos_hint: {'center_x': 0.5, 'center_y': 0.5}
                    fit_mode: "contain"
                    opacity: 1

                ScrollView:
                    id: results_scrollview
                    bar_width: dp(8)
                    do_scroll_x: False
                    # El canvas de aquí se vuelve redundante, el padre controla el fondo
                    BoxLayout:
                        id: results_container
                        orientation: 'vertical'
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(10)
                        padding: dp(10)

        # 3. Barra Inferior de Progreso
        BoxLayout:
            size_hint_y: None
            height: dp(90)
            padding: [dp(15), dp(8)]
            spacing: dp(15)
            canvas.before:
                Color:
                    rgba: COLOR_WHITE
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: COLOR_GREY
                Line:
                    points: self.x, self.top, self.right, self.top
                    width: 1.2

            ProgressBar:
                id: bottom_scan_progressbar
                value: root.scan_progress
                size_hint_x: 0.3
                max: 100

            # Contenedor para el texto de estado principal
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: 0.45
                Label:
                    id: bottom_status_text
                    text: root.scan_status
                    font_size: '13sp'
                    color: COLOR_TEXT_DARK
                    halign: 'left'
                    valign: 'bottom'
                    text_size: self.width, None
                Label:
                    id: bottom_current_host_label
                    text: ("Escaneando: " + root.current_host) if root.current_host else ""
                    font_size: '11sp'
                    color: (0.4, 0.4, 0.4, 1)
                    halign: 'left'
                    valign: 'top'
                    text_size: self.width, None

            # Contenedor para la etiqueta de estado de la IA, alineado a la derecha
            BoxLayout:
                orientation: 'vertical'
                size_hint_x: 0.25
                Label:
                    text: 'IA: ' + root.ia_status
                    font_size: '12sp'
                    color: root.ia_status_color
                    bold: True
                    halign: 'right'
                    valign: 'middle'
                    text_size: self.width, None