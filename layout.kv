#:import Graph kivy.garden.graph.Graph
#:import MeshLinePlot kivy.garden.graph.MeshLinePlot
#:import dp kivy.metrics.dp
# Importar el widget Image
#:import Image kivy.uix.image.Image

#:set UNIR_BLUE (0/255, 105/255, 170/255, 1)
#:set UNIR_DARK_BLUE (0/255, 85/255, 142/255, 1)
#:set UNIR_WHITE (1, 1, 1, 1)
#:set UNIR_LIGHT_GREY (242/255, 242/255, 242/255, 1)
#:set UNIR_TEXT_DARK (0.1, 0.1, 0.1, 1)
#:set UNIR_TEXT_ON_BLUE (1, 1, 1, 1)

<HostDataGroup>:
    canvas.before:
        Color:
            rgba: (0.85, 0.85, 0.85, 1)
        Line:
            rectangle: self.x + dp(1), self.y + dp(1), self.width - dp(2), self.height - dp(2)
            width: 1

<DashboardScreen>:
    # El fondo de pantalla de la ventana principal es BLANCO.
    canvas.before:
        Color:
            rgba: UNIR_WHITE
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: 'vertical'
        spacing: 0

        # Barra de herramientas superior (header_bar)
        BoxLayout:
            id: header_bar
            size_hint_y: None
            height: dp(70)
            padding: [dp(10), dp(5), dp(10), dp(5)]
            spacing: dp(10)
            canvas.before:
                Color:
                    rgba: UNIR_BLUE # Fondo azul sólido para la barra superior
                Rectangle:
                    pos: self.pos
                    size: self.size

            # Contenedor para el título "ScanIA" 
            BoxLayout:
                size_hint_x: 0.7
                spacing: dp(10)

                Label:
                    text: 'ScanIA'
                    font_size: '32sp'
                    bold: True
                    color: UNIR_TEXT_ON_BLUE
                    halign: 'center' # Centrado horizontalmente
                    valign: 'middle'
                    text_size: self.size
                    size_hint_x: 1

            BoxLayout: # Espacio para los botones de la derecha
                size_hint_x: 0.3
                spacing: dp(5)
                padding: [0, dp(5), 0, dp(5)]
                Button:
                    text: 'Exportar'
                    on_press: root.export_results_to_pdf()
                    background_normal: ''
                    background_color: UNIR_DARK_BLUE
                    color: UNIR_TEXT_ON_BLUE
                    font_size: '12sp'
                    bold: True
                Button:
                    text: 'Ayuda'
                    on_press: print("Ayuda!") # Placeholder para la funcionalidad de ayuda
                    background_normal: ''
                    background_color: UNIR_DARK_BLUE
                    color: UNIR_TEXT_ON_BLUE
                    font_size: '12sp'
                    bold: True

        BoxLayout: # Área principal de contenido (panel izquierdo y derecho)
            orientation: 'horizontal'
            spacing: dp(5)
            padding: [dp(5), dp(5), dp(5), dp(5)]

            ScrollView: # Panel Izquierdo (Configuración de Escaneo)
                size_hint_x: 0.35
                bar_width: dp(8)
                do_scroll_x: False
                canvas.before:
                    Color:
                        rgba: UNIR_LIGHT_GREY + (0.8,) # Fondo gris claro con 80% de opacidad
                    Rectangle:
                        pos: self.pos
                        size: self.size
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(8)
                    padding: dp(10)
                    Label:
                        text: 'CONFIGURACIÓN DE ESCANEO'
                        font_size: '16sp'
                        bold: True
                        size_hint_y: None
                        height: dp(30)
                        color: UNIR_TEXT_DARK

                    Label:
                        text: 'Rango de IP:'
                        size_hint_y: None
                        height: dp(20)
                        color: UNIR_TEXT_DARK
                        halign: 'left'
                        text_size: self.width, None

                    # Campos de IP separados por octetos - IP Inicial
                    BoxLayout:
                        orientation: 'horizontal'
                        spacing: dp(2)
                        size_hint_y: None
                        height: dp(30)
                        TextInput:
                            id: ip_inicial_octet1
                            input_filter: 'int'
                            multiline: False
                            size_hint_x: None # No estirar
                            width: dp(50) # Ancho fijo para 3 dígitos
                            halign: 'center'
                            input_type: 'number'
                            write_tab: False # Disable tab for navigation between octets
                            max_length: 3 # Limit to 3 characters
                            on_text: root._validate_octet_input('ip_inicial_octet1', self); root._handle_octet_input('ip_inicial_octet1', self, self.text)
                            on_text_validate: self.focus_next() # Move focus on Enter
                        Label:
                            text: '.'
                            size_hint_x: None
                            width: dp(10)
                            color: UNIR_TEXT_DARK
                        TextInput:
                            id: ip_inicial_octet2
                            input_filter: 'int'
                            multiline: False
                            size_hint_x: None
                            width: dp(50) # Ancho fijo para 3 dígitos
                            halign: 'center'
                            input_type: 'number'
                            write_tab: False
                            max_length: 3 # Limit to 3 characters
                            on_text: root._validate_octet_input('ip_inicial_octet2', self); root._handle_octet_input('ip_inicial_octet2', self, self.text)
                            on_text_validate: self.focus_next()
                        Label:
                            text: '.'
                            size_hint_x: None
                            width: dp(10)
                            color: UNIR_TEXT_DARK
                        TextInput:
                            id: ip_inicial_octet3
                            input_filter: 'int'
                            multiline: False
                            size_hint_x: None
                            width: dp(50) # Ancho fijo para 3 dígitos
                            halign: 'center'
                            input_type: 'number'
                            write_tab: False
                            max_length: 3 # Limit to 3 characters
                            on_text: root._validate_octet_input('ip_inicial_octet3', self); root._handle_octet_input('ip_inicial_octet3', self, self.text)
                            on_text_validate: self.focus_next()
                        Label:
                            text: '.'
                            size_hint_x: None
                            width: dp(10)
                            color: UNIR_TEXT_DARK
                        TextInput:
                            id: ip_inicial_octet4
                            input_filter: 'int'
                            multiline: False
                            size_hint_x: None
                            width: dp(50) # Ancho fijo para 3 dígitos
                            halign: 'center'
                            input_type: 'number'
                            write_tab: False
                            max_length: 3 # Limit to 3 characters
                            on_text: root._validate_octet_input('ip_inicial_octet4', self); root._handle_octet_input('ip_inicial_octet4', self, self.text)
                            on_text_validate: self.focus_next()

                    Label:
                        text: 'hasta'
                        size_hint_y: None
                        height: dp(20)
                        color: UNIR_TEXT_DARK
                        halign: 'left'
                        text_size: self.width, None

                    # Campos de IP separados por octetos - IP Final
                    BoxLayout:
                        orientation: 'horizontal'
                        spacing: dp(2)
                        size_hint_y: None
                        height: dp(30)
                        TextInput:
                            id: ip_final_octet1
                            input_filter: 'int'
                            multiline: False
                            size_hint_x: None
                            width: dp(50) # Ancho fijo para 3 dígitos
                            halign: 'center'
                            input_type: 'number'
                            write_tab: False
                            max_length: 3 # Limit to 3 characters
                            on_text: root._validate_octet_input('ip_final_octet1', self); root._handle_octet_input('ip_final_octet1', self, self.text)
                            on_text_validate: self.focus_next()
                        Label:
                            text: '.'
                            size_hint_x: None
                            width: dp(10)
                            color: UNIR_TEXT_DARK
                        TextInput:
                            id: ip_final_octet2
                            input_filter: 'int'
                            multiline: False
                            size_hint_x: None
                            width: dp(50) # Ancho fijo para 3 dígitos
                            halign: 'center'
                            input_type: 'number'
                            write_tab: False
                            max_length: 3 # Limit to 3 characters
                            on_text: root._validate_octet_input('ip_final_octet2', self); root._handle_octet_input('ip_final_octet2', self, self.text)
                            on_text_validate: self.focus_next()
                        Label:
                            text: '.'
                            size_hint_x: None
                            width: dp(10)
                            color: UNIR_TEXT_DARK
                        TextInput:
                            id: ip_final_octet3
                            input_filter: 'int'
                            multiline: False
                            size_hint_x: None
                            width: dp(50) # Ancho fijo para 3 dígitos
                            halign: 'center'
                            input_type: 'number'
                            write_tab: False
                            max_length: 3 # Limit to 3 characters
                            on_text: root._validate_octet_input('ip_final_octet3', self); root._handle_octet_input('ip_final_octet3', self, self.text)
                            on_text_validate: self.focus_next()
                        Label:
                            text: '.'
                            size_hint_x: None
                            width: dp(10)
                            color: UNIR_TEXT_DARK
                        TextInput:
                            id: ip_final_octet4
                            input_filter: 'int'
                            multiline: False
                            size_hint_x: None
                            width: dp(50) # Ancho fijo para 3 dígitos
                            halign: 'center'
                            input_type: 'number'
                            write_tab: False
                            max_length: 3 # Limit to 3 characters
                            on_text: root._validate_octet_input('ip_final_octet4', self); root._handle_octet_input('ip_final_octet4', self, self.text) # Keep original validation
                            on_text_validate: root.validar_y_analizar() # Trigger scan or validation on last octet enter

                    Label:
                        text: 'Opciones de Escaneo:'
                        size_hint_y: None
                        height: dp(25)
                        color: UNIR_TEXT_DARK
                        bold: True
                        halign: 'left'
                        text_size: self.width, None

                    GridLayout:
                        cols: 2
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(5)
                        padding: [0, dp(5)]

                        CheckBox:
                            id: nmap_opt_sS
                            active: False
                            size_hint_x: None
                            width: dp(30)
                            size_hint_y: None
                            height: dp(30)
                        Label:
                            text: 'Escaneo SYN'
                            color: UNIR_TEXT_DARK
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'middle'
                            size_hint_y: None
                            height: dp(30)

                        CheckBox:
                            id: nmap_opt_sT
                            active: False
                            size_hint_x: None
                            width: dp(30)
                            size_hint_y: None
                            height: dp(30)
                        Label:
                            text: 'Escaneo TCP Connect'
                            color: UNIR_TEXT_DARK
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'middle'
                            size_hint_y: None
                            height: dp(30)

                        CheckBox:
                            id: nmap_opt_sU
                            active: False
                            size_hint_x: None
                            width: dp(30)
                            size_hint_y: None
                            height: dp(30)
                        Label:
                            text: 'Escaneo UDP'
                            color: UNIR_TEXT_DARK
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'middle'
                            size_hint_y: None
                            height: dp(30)

                        CheckBox:
                            id: nmap_opt_O
                            active: False
                            size_hint_x: None
                            width: dp(30)
                            size_hint_y: None
                            height: dp(30)
                        Label:
                            text: 'Detección de Sistema Operativo'
                            color: UNIR_TEXT_DARK
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'middle'
                            size_hint_y: None
                            height: dp(30)


                        CheckBox:
                            id: nmap_opt_sV
                            active: True
                            size_hint_x: None
                            width: dp(30)
                            size_hint_y: None
                            height: dp(30)
                        Label:
                            text: 'Detección de Versión de Servicio'
                            color: UNIR_TEXT_DARK
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'middle'
                            size_hint_y: None
                            height: dp(30)

                        CheckBox:
                            id: nmap_opt_Pn
                            active: False
                            size_hint_x: None
                            width: dp(30)
                            size_hint_y: None
                            height: dp(30)
                        Label:
                            text: 'No realizar Ping (Omitir descubrimiento)'
                            color: UNIR_TEXT_DARK
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'middle'
                            size_hint_y: None
                            height: dp(30)

                        CheckBox:
                            id: nmap_opt_vulners
                            active: True
                            size_hint_x: None
                            width: dp(30)
                            size_hint_y: None
                            height: dp(30)
                        Label:
                            text: 'Análisis de Vulnerabilidades (Vulners)'
                            color: UNIR_TEXT_DARK
                            text_size: self.width, None
                            halign: 'left'
                            valign: 'middle'
                            size_hint_y: None
                            height: dp(30)

                    Label:
                        text: 'Argumentos Adicionales (Nmap):'
                        size_hint_y: None
                        height: dp(20)
                        color: UNIR_TEXT_DARK
                        halign: 'left'
                        text_size: self.width, None
                    TextInput:
                        id: custom_nmap_args_input
                        hint_text: 'Ej: -T4 --top-ports 20'
                        multiline: False
                        size_hint_y: None
                        height: dp(30)
                        background_color: UNIR_WHITE
                        foreground_color: UNIR_TEXT_DARK

                    Widget:
                        size_hint_y: 0.1

                    Button:
                        id: scan_button
                        # Lógica para que el mismo botón inicie y detenga el escaneo
                        text: "DETENER ESCANEO" if root.scan_active else "INICIAR ESCANEO"
                        size_hint_y: None
                        height: dp(50)
                        background_normal: ''
                        # Color rojo si el escaneo está activo, azul si no
                        background_color: (0.8, 0.2, 0.2, 1) if root.scan_active else UNIR_BLUE
                        color: UNIR_TEXT_ON_BLUE
                        # Llama a cancelar si está activo, a validar_y_analizar si no
                        on_press: root.cancel_scan() if root.scan_active else root.validar_y_analizar()
                        # 'disabled' ya no es necesario aquí, la lógica de 'on_press' lo maneja.

                    Label:
                        id: status_label
                        markup: True
                        text: 'Ingrese un rango de IP y seleccione las opciones de escaneo.'
                        font_size: '14sp'
                        size_hint_y: None
                        height: dp(60)
                        text_size: self.width, None
                        halign: 'center'
                        valign: 'middle'
                        color: UNIR_TEXT_DARK

            ScrollView: # Panel Derecho (Results)
                id: results_scrollview
                size_hint_x: 0.65
                bar_width: dp(8)
                do_scroll_x: False
                canvas.before:
                    # Fondo blanco con 80% de opacidad para el ScrollView
                    Color:
                        rgba: UNIR_WHITE + (0.8,)
                    Rectangle:
                        pos: self.pos
                        size: self.size
                    # Borde para el área de resultados (ScrollView)
                    Color:
                        rgba: UNIR_DARK_BLUE # Color del borde (azul oscuro)
                    Line:
                        rectangle: self.x, self.y, self.width, self.height
                        width: 1.5 # Grosor de la línea

                BoxLayout:
                    id: results_container # Este BoxLayout contendrá el contenido real
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height # Ajustar a min_height para permitir el scroll
                    spacing: dp(10)
                    padding: dp(10)
                    # La imagen de fondo `Fondo.jpg` ha sido eliminada de aquí para evitar que cubra la gráfica.
                    # El fondo blanco y el borde azul ya son proporcionados por el ScrollView.

        # Bottom Bar for Progress and Status
        BoxLayout:
            id: bottom_bar
            size_hint_y: None
            height: dp(50)
            padding: [dp(10), dp(5), dp(10), dp(5)]
            spacing: dp(10)
            canvas.before:
                Color:
                    rgba: UNIR_LIGHT_GREY + (0.95,) # Slightly transparent light grey background
                Rectangle:
                    pos: self.pos
                    size: self.size

            ProgressBar:
                id: bottom_scan_progressbar
                value: root.scan_progress
                size_hint_x: 0.3
                max: 100

            BoxLayout:
                orientation: 'vertical'
                size_hint_x: 0.7
                Label:
                    id: bottom_status_text
                    text: root.scan_status
                    font_size: '12sp'
                    color: UNIR_TEXT_DARK
                    halign: 'left'
                    text_size: self.width, None
                    valign: 'middle'
                Label:
                    id: bottom_current_host_label
                    text: root.current_host
                    font_size: '11sp'
                    color: UNIR_TEXT_DARK
                    halign: 'left'
                    text_size: self.width, None
                    valign: 'middle'